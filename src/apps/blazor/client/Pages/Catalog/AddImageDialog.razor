@using FSH.Starter.Blazor.Infrastructure.Api
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Forms
@using System.Net.Http.Headers
@using Microsoft.JSInterop


<MudDialog>
    <TitleContent>
        <MudText>Add New Image</MudText>
    </TitleContent>
    <DialogContent>
        <MudForm @ref="_form">
            <MudGrid>
                <MudItem xs="12">
                    <MudFileUpload T="IReadOnlyList<IBrowserFile>"
                                   @ref="_fileUpload"
                                   OnFilesChanged="OnInputFileChanged"
                                   AppendMultipleFiles
                                   Hidden="@false"
                                   InputClass="file-upload-input"
                                   ErrorText="@string.Empty"
                                   tabindex="-1"
                                   @ondrop="@ClearDragClass"
                                   @ondragenter="@SetDragClass"
                                   @ondragleave="@ClearDragClass"
                                   @ondragend="@ClearDragClass">
                        <ActivatorContent>
                            <MudPaper Height="300px"
                                      Outlined="true"
                                      Class="@_dragClass">
                                <MudText Typo="Typo.h6">
                                    Drag and drop files here or click
                                </MudText>
                                @foreach (var file in _fileNames ?? Enumerable.Empty<string>())
                                {
                                    <MudChip T="string" Color="Color.Dark" Text="@file" />
                                }
                            </MudPaper>
                        </ActivatorContent>
                    </MudFileUpload>
                </MudItem>
            </MudGrid>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="UploadImage" Disabled="!CanUploadImage">
            Upload
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    private const string DefaultDragClass = "relative rounded-lg border-2 border-dashed pa-4 mt-4 mud-width-full mud-height-full";
    private string _dragClass = DefaultDragClass;
    private readonly List<string> _fileNames = new();

    [Parameter] public Guid SomeEventId { get; set; }
    [Parameter] public EventCallback<EventArgs> OnImageAdded { get; set; }
    [Inject] private IApiClient Client { get; set; } = default!;
    [Inject] private HttpClient Http { get; set; } = default!;

    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = default!;

    private MudFileUpload<IReadOnlyList<IBrowserFile>>? _fileUpload;

    private List<IBrowserFile> _selectedFiles = new List<IBrowserFile>();

    private Dictionary<string, string> _previewUrls = new();
    private MudForm _form = new();
    private bool _isDragOver = false;

    private void ClearDragClass()
        => _dragClass = DefaultDragClass;
    private void SetDragClass()
    => _dragClass = $"{DefaultDragClass} mud-border-primary";
    private void OnInputFileChanged(InputFileChangeEventArgs e)
    {
        var files = e.GetMultipleFiles(); // Allow multiple files
        // Process files asynchronously but don't await in the event handler
        _ = ProcessFiles(files.ToArray());
    }

    private string GetDropZoneClass()
    {
        return _isDragOver ? "drag-over" : "";
    }

    private async Task OnDragEnter(DragEventArgs e)
    {
        _isDragOver = true;
        StateHasChanged();
        await Task.CompletedTask;
    }

    private async Task OnDragOverAsync(DragEventArgs e)
    {
        _isDragOver = true;
        StateHasChanged();
        await Task.CompletedTask;
    }

    private async Task OnDragLeave(DragEventArgs e)
    {
        _isDragOver = false;
        StateHasChanged();
        await Task.CompletedTask;
    }

    private async Task OnDropAsync(DragEventArgs e)
    {
        _isDragOver = false;
        StateHasChanged();
        // Note: Direct file access from drag/drop isn't supported in Blazor WebAssembly
        // We'll rely on the MudFileUpload for the actual file selection
        await Task.CompletedTask;
    }

    private async Task TriggerFileInput()
    {
        await Task.Delay(1); // Small delay to allow UI to update
        // Note: In Blazor WebAssembly, we can't directly trigger the file input via JS interop easily
        // So we'll just ensure the MudFileUpload is accessible
    }

    private async Task ProcessFiles(IBrowserFile[] files)
    {

        _previewUrls.Clear();

        foreach (var file in files)
        {
            _selectedFiles.Add(file);
            _fileNames.Add(file.Name);
            var buffer = new byte[file.Size];
            await file.OpenReadStream(maxAllowedSize: 5242880).ReadAsync(buffer);
            var base64 = Convert.ToBase64String(buffer);
            var previewUrl = $"data:{file.ContentType};base64,{base64}";
            _previewUrls[file.Name] = previewUrl;

        }

        StateHasChanged();
        await Task.CompletedTask;
    }

    // Removed duplicate method definitions to fix build errors

    private async Task RemoveFileAsync(int index)
    {
        var nameSelected = _selectedFiles[index]?.Name;
        _selectedFiles.RemoveAt(index);

        if (!string.IsNullOrEmpty(nameSelected) && _previewUrls.ContainsKey(nameSelected))
        {
            _previewUrls.Remove(nameSelected);
        }

        StateHasChanged();
        await Task.CompletedTask;
    }

    private string FormatFileSize(long size)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double len = size;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len /= 1024;
        }

        return $"{len:0.##} {sizes[order]}";
    }

    private bool CanUploadImage => _selectedFiles.Any();

    private async Task UploadImage()
    {
        if (!CanUploadImage) return;

        try
        {
            // Loop through each selected file and upload individually
            foreach (var file in _selectedFiles)
            {
                // Create multipart form data for each file
                var formData = new MultipartFormDataContent();
                
                // Add the image file
                var fileContent = new StreamContent(file.OpenReadStream(maxAllowedSize: 5242880));
                fileContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue(file.ContentType);
                formData.Add(fileContent, "Image", file.Name);
                
                // Add SomeEventId as form field
                var eventIdContent = new StringContent(SomeEventId.ToString());
                eventIdContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue("text/plain");
                formData.Add(eventIdContent, "SomeEventId");
                
                // Make the HTTP POST request directly
                var response = await Http.PostAsync("api/v1/eventimages", formData);
                
                if (!response.IsSuccessStatusCode)
                {
                    var errorContent = await response.Content.ReadAsStringAsync();
                    Console.WriteLine($"Error uploading image: {response.StatusCode} - {errorContent}");
                    // Consider showing an error message to the user
                    return; // Stop uploading if there's an error
                }
            }
            
            // Notify parent component after all files are uploaded
            await OnImageAdded.InvokeAsync(EventArgs.Empty);
            
            // Close dialog
            MudDialog.Close();
        }
        catch (Exception ex)
        {
            // Handle error appropriately
            Console.WriteLine($"Error uploading image: {ex.Message}");
            // In real app, show proper error message
        }
    }

    private async Task Cancel() =>  MudDialog.Cancel();
}

<style>
    .file-upload-input {
        position: absolute;
        width: 100%;
        height: 100%;
        overflow: hidden;
        z-index: 10;
        opacity: 0;
    }
</style>
